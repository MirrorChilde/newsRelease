<template>
  <div class="news">
    <div class="top">
      <span @click="log">
        共有<span style="color: #f56c6c;">{{ total }}</span>位用户信息
      </span>
      <div>
        <el-button type="primary" icon="el-icon-plus" @click="addAuditor">
          新建审核员账号
        </el-button>
      </div>
    </div>

    <div class="usersList">
      <el-table :data="usersList" style="width: 100%" :header-cell-style="{ background: '#E8EBEF' }">
        <el-table-column label="用户昵称" width="250">
          <template slot-scope="scope">
            <span>{{ scope.row.nickName }}</span>
          </template>
        </el-table-column>
        <el-table-column label="用户邮箱" width="250">
          <template slot-scope="scope">
            <span>{{ scope.row.email }}</span>
          </template>
        </el-table-column>
        <el-table-column label="用户角色" ref="filterTable"
          :filters="[{ text: '用户', value: '用户' }, { text: '新闻审核员', value: '新闻审核员' }, { text: '系统管理员', value: '系统管理员' }]"
          :filter-method="filterRole" width="200">
          <template slot-scope="scope">
            <div slot="reference" class="title-wrapper">
              <!-- <el-tag size="medium" >{{ scope.row.focus?'已封禁':'正常' }}</el-tag> -->
              <!-- <span   >{{ scope.row.roleName }}</span> -->
              <el-select v-model="scope.row.roleName" placeholder="请选择" @change="changeRole($event, scope.row.id)">
                <el-option v-for="item in options" :key="item.value" :label="item.label" :value="item.value">
                </el-option>
              </el-select>
            </div>
          </template>
        </el-table-column>
        <el-table-column label="操作">
          <template slot-scope="scope">
            <el-button size="mini" type="success" plain @click="handleEdit(scope.$index, scope.row)">解封</el-button>
            <el-button size="mini" type="danger" plain
              @click="handleDelete(scope.$index, scope.row, false)">暂时封禁</el-button>
            <el-button size="mini" type="danger" @click="handleDelete(scope.$index, scope.row, true)">永久封禁</el-button>
          </template>
        </el-table-column>
      </el-table>
    </div>
    <div class="block" style="margin-top: 15px;">
      <el-pagination small @size-change="handleSize" @current-change="handleCur" :current-page.sync="current"
        :page-sizes="[10, 20, 30, 40]" :page-size="size" layout="sizes, prev, pager, next" :total="total">
      </el-pagination>
    </div>
    <el-dialog title="封禁时间(单位：天)" :visible.sync="dialogFormVisible" width="30%">
      <el-input-number v-model="duration" :min="1" :max="365" label="封禁天数"></el-input-number>
      <div slot="footer" class="dialog-footer">
        <el-button @click="dialogFormVisible = false">取 消</el-button>
        <el-button type="primary" @click="bannedUser(banUserId, duration)">确 定</el-button>
      </div>
    </el-dialog>
    <!-- 新建账号弹框 -->
    <el-dialog title="新建审核员账号" :visible.sync="dialogAuditVisible" width="30%">
      <el-form :model="accountForm" :rules="rules" ref="formName" label-width="100px" class="demo-accountForm">
        <el-form-item label="账号" prop="username">
          <el-input type="text" v-model="accountForm.username" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="密码" prop="password">
          <el-input type="password" v-model="accountForm.password" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="确认密码" prop="checkPass">
          <el-input type="password" v-model="accountForm.checkPass" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="邮箱" prop="email">
          <el-input type="email" v-model="accountForm.email" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="昵称" prop="account">
          <el-input type="text" v-model="accountForm.nickName" autocomplete="off"></el-input>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="resetForm()" ref="cancelNew">取 消</el-button>
        <el-button type="primary" @click="addAuditor('accountForm')">确 定</el-button>
      </div>
    </el-dialog>
  </div>
</template>

<script>
export default {
  name: 'News',
  data() {
    var validatePass2 = (rule, value, callback) => {
      if (value === '') {
        callback(new Error('请再次输入密码'));
      } else if (value !== this.accountForm.password) {
        console.log(this.accountForm.password, value)
        callback(new Error('两次输入密码不一致!'));
      } else {
        callback();
      }
    };
    return {
      input: '',
      changeFormVisible: false,
      usersList: [],
      dialogFormVisible: false,
      dialogAuditVisible: false,
      banUserId: '',
      duration: 1,
      current: 1,
      size: 10,
      total: 100,
      accountForm: {
        username: '',
        password: '',
        checkPass: '',
        email: '',
        nickName: ''
      },
      rules: {
        username: [
          { min: 6, max: 16, message: '账号必须为6-16位', required: true, trigger: 'blur' }
        ],
        password: [
          { min: 6, max: 16, message: '密码长度不小于6位，不大于16位', required: true, trigger: 'blur' }
        ],
        checkPass: [
          { validator: validatePass2, required: true, trigger: 'blur' }
        ],
        email: [
          { required: true, message: '请输入邮箱地址', trigger: 'blur' },
          { type: 'email', message: '请输入正确的邮箱地址', trigger: ['blur', 'change'] }
        ]
      },
      options: [{
        value: '1',
        label: '用户'
      }, {
        value: '4',
        label: '系统管理员'
      }, {
        value: '2',
        label: '新闻审核员'
      }],
      value: ''
    }
  },
  mounted() {
    let token = sessionStorage.getItem('token')
    this.getUsersList();
  },
  methods: {
    log() {
      console.log(this.$refs.cancelNew)
      // this.$refs.cancelNew.click()
    },
    handleEdit(index, row) {
      // console.log(index, row);
      this.bannedUser(row.userId, 0);
    },
    handleDelete(index, row, forever) {
      if (!forever) {
        this.dialogFormVisible = true
        // this.banUserId = row.userId
      }
      else {
        this.$message({
          type: 'success',
          message: '操作成功'
        });
      }
      // this.bannedUser(row.userId, -99);
    },
    handleSize(val) {
      this.size = val;
      this.getUsersList();
    },
    handleCur(val) {
      this.current = val;
      this.getUsersList();
    },
    getUsersList() {
      this.axios({
        method: "GET",
        url: `/api/user/admin/list?current=${this.current}&&size=${this.size}`,
        header: this.token
      }).then(res => {
        console.log(res);
        this.usersList = res.data.data.records.reverse();
        this.total = +res.data.data.total
      }).catch(err => {
        console.log(err);
      })
    },
    bannedUser(userId, duration) {
      this.$message({
        type: 'success',
        message: '操作成功'
      });
      this.dialogFormVisible = false;
      // this.axios({
      //   method: "POST",
      //   url: "/api/admin/bannedUser",
      //   data: {
      //     userId: userId,
      //     duration: duration,
      //   }
      // }).then(res => {
      //   console.log(res);
      //   if (res.data.code == "200") {
      //     this.$message({
      //       type: 'success',
      //       message: '操作成功'
      //     });
      //   }
      //   this.dialogFormVisible = false;
      //   this.getUsersList();
      // }).catch(err => {
      //   console.log(err);
      // })
    },
    addAuditor(formName) {
      this.dialogAuditVisible = true;
      this.$refs.formName.validate((valid) => {
        if (valid) {
          this.axios({
            method: "POST",
            url: "/api/user/admin/addNewAuditor",
            data: this.accountForm
          }).then(res => {
            console.log(res);
            if (res.data.code === 200) {
              this.$message({
                type: 'success',
                message: "新建账号成功"
              })
              this.dialogAuditVisible = false
            }
            else
              this.$message({
                type: 'warning',
                message: res.data.msg
              })
          }).catch(err => {
            console.log(err);
          })
        } else {
          this.$message({
            type: 'error',
            message: "账号/密码不符合要求"
          });
          return false;
        }
      });
    },
    resetForm() {
      this.dialogAuditVisible = false
      this.$refs[formName].resetFields();
    },
    open() {
      this.$confirm('此操作将永久删除该文件, 是否继续?', '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      }).then(() => {
        this.$message({
          type: 'success',
          message: '删除成功!'
        });
      }).catch(() => {
        this.$message({
          type: 'info',
          message: '已取消删除'
        });
      });
    },
    changeRole(e, id) {
      console.log(e, id)
      this.axios({
        method: "POST",
        url: "/api/user/admin/changeRole",
        data: {
          userId: id,
          roleId: e
        }
      }).then(res => {
        console.log(res);
        if (res.data.code === 200) {
          this.$message({
            type: 'success',
            message: "修改成功"
          })
        }
        else
          this.$message({
            type: 'warning',
            message: res.data.msg
          })
      }).catch(err => {
        console.log(err);
      })
    },
    // 选择器
    clearFilter() {
      this.$refs.filterTable.clearFilter();
    },
    filterRole(value, row) {
      console.log(value);
      // this.axios({
      //   method: "GET",
      //   url: `/api/user/admin/list?current=${this.current}&&size=${this.size}`,
      //   header: this.token
      // }).then(res => {
      //   console.log(res);
      //   var resList = res.data.data.records.reverse();
      //   this.usersList = resList.map(e => {
      //     return e.roleName == value
      //   });
      // }).catch(err => {
      //   console.log(err);
      // })
      // var lable=value == '审核中' ?0: (scope.row.status == '3' ? '审核不通过': '审核成功')
      return row.roleName == value;
    },
  }
}

</script>
<style scoped>
.top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-direction: row;
  margin: 10px 0;
  /* width: 80%; */
}

.usersList {
  margin: 0px auto;
}

a {
  text-decoration: none;
  color: #ffff;
}
</style>
